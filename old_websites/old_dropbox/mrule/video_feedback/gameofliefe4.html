<html>
<head>
<title>Hi there</title>
<script src="math.js" type="text/javascript"></script>
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css">
.item { 
    -moz-user-select: -moz-none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    -o-user-select: none;
    user-select: none;
}
#canvas {
    width: 100%; 
    height: 100%;
    padding: 0;
    margin:0;
    position: absolute; 
    top: 0; 
    right: 0; 
    bottom: 0; 
    left: 0;
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    -ms-interpolation-mode: nearest-neighbor;
}
* { margin:0; padding:0; }
</style>

</head>
<body onload="perceptron()" bgcolor="#000">
<canvas id="canvas" width="100%" height="100%">Sorry, your browser does not support JavaScript canvas, or it is disabled.</canvas>
<script type="application/javascript">

/** As far a I can tell this is how you do println in Javascript? */
function print(msg){
    console.log(msg);
}

function perceptron(){
    print('loading');

    var MAPFIXEDP = 16;
    var factor = 3;
    var W  = Math.floor(window.innerWidth/factor);
    var H  = Math.floor(window.innerHeight/factor);
    var W2 = W/2;
    var H2 = H/2;
    print(W);
    print(H);
    var CMASK = 0xf0f0f0;
    
    /* prepare canvas */
    var canvas = document.getElementById('canvas');
    canvas.width  = W; 
    canvas.height = H; 
    var ctx = canvas.getContext('2d');
    var imageData = ctx.getImageData(0,0,W,H);
    canvas.onselectstart = function(){return false;}
    canvas.className = "item"
	
    var buff1 = new Uint32Array( W*H + 1);
    var buff2 = new Uint32Array( W*H + 1);         
    var data  = new Uint32Array(imageData.data.buffer);
	var running = true;
	var downX   = null; 
	var downY   = null;
    var buffPrev = new Uint32Array(W);
    var buffCurr = new Uint32Array(W);
    var buffNext = new Uint32Array(W);
	var skipframes = 3;
	
    function render() {
		for (var iter=0;iter<skipframes;iter++) {
            for (var x=0; x<W; ++x) {
			    var prev = buff1[x+W*(H-2)];
			    var curr = buff1[x+W*(H-1)];
			    var next = buff1[x];
			    var sums = prev+curr+next;
	            for (var y=0; y<H; ++y) {
				    sums-= prev;
				    prev = curr;
				    curr = next;
				    next = buff1[(y<H-1?y+1:0)*W+x];
				    sums+= next;
				    buff2[x+W*y]=sums;
			    }
		    }
            var writeindex = 0;
		    var changed = false;
            for (var y=0; y<H; ++y) {
			    var i = W*y;
			    var prev = buff2[i+W-2];
			    var curr = buff2[i+W-1];
			    var next = buff2[i];
			    var sums = prev+curr+next;
	            for (var x=0; x<W; ++x) {
	                indx = y*W+x;
				    sums-= prev;
				    prev = curr;
				    curr = next;
				    next = buff2[(x<W-1?x+1:0)+i];
				    sums+= next;
				    var color = buff1[indx];
				    if (sums==3) color=1;
				    else if (color&&sums!=4) color=0;
	                buff1[indx] = color;
	                color = ~(color*0xffffff);
				    data[indx] = 0xff000000 | (((data[indx]&0xfefefe)+(color&0xfefefe))>>1);
	            }
		    }
		}
        ctx.putImageData(imageData,0,0);
        //if (running) setTimeout(render, 0);
        if (running) window.requestAnimationFrame(render);
    }
	document.onmousemove = function(e) {
		if (!running) return;
		var x = Math.floor(e.pageX/factor);//-canvas.offsetLeft;
		var y = Math.floor(e.pageY/factor);//-canvas.offsetTop;
        var rand = Math.floor(Math.random()*0x1000000);
		for (var xi=-1; xi<=1; xi++)
		for (var yi=-1; yi<=1; yi++) {
			var xj=x+xi;
			var yj=y+yi;
			yj=yj<0?0:yj>=H?H-1:yj;
			xj=xj<0?0:xj>=W?W-1:xj;
			rand ^= rand>>2^rand<<1;
			buff1[xj+W*yj]=rand&1;
		}
	}
	document.onmousedown = function(e) {
		downX = e.pageX;
		downY = e.pageY;
	}
	document.onclick = function(e) {
		if (downX==e.pageX && downY==e.pageY) {
			if (running) {
				running=false;
				print('stopping');
			}
			else {
				running=true;
	    		setTimeout(render,0);
				print('starting');
			}
		}
	}
    print('starting');
    setTimeout(render, 0);
}

</script>

</body>
</html>
