<html>
<head>
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css">
body { 
    background-color: #333;
    margin:0 auto;
    font-family: "Lucida Console", Monaco, monospace;
    color:black;
    line-height: 130%; 
    text-decoration:none; 
}
.dropshadow {
    width:827px;
    margin:0 auto;
    padding: 0 10 15 10;
    -moz-box-shadow:    0px 0px 14px #000;
	-webkit-box-shadow: 0px 0px 14px #000;
	box-shadow:         0px 0px 14px #000;
}
.pview {
    width:512px;
    height:512px;
    float: right;
}
.pcontainer {
    width:825px;
    height:512px;
    float: right;
    margin: 100px auto;
}
.pcursor {
    width: 11px;
    height:11px;
    margin: -11 0;
    background-color: #333;
    border: solid 1px #aaa;
	position: relative;
    /* rounded corners ( does not work in opera, IE ) */
    -moz-border-radius:    6px;
    -webkit-border-radius: 6px;
    -khtml-border-radius:  6px;
    border-radius:         6px;
}
</style>
</head>
<body onload="demo()">

<div class="dropshadow">
<div class="pcontainer">

<div class="pview">
<canvas id="canvas" width="1" height="1"">Sorry, your browser does not support JavaScript canvas, or it is disabled.</canvas>
</div>

</div>
<br clear="all" />
</div>

<script type="application/javascript">

function print(msg) {
    setTimeout(function() {
        throw new Error(msg);
    }, 0);
}

function demo() {
	var N  = 512;
	var N2 = N/2;

	var canvas = document.getElementById('canvas');
	canvas.width  = N; 
	canvas.height = N; 
	var ctx = canvas.getContext('2d');
	var imageData = ctx.getImageData(0, 0, N, N);

	var map  = new Int32Array( N*N*2 );
	for (var y = 0; y < N; ++y) {
		for (var x = 0; x < N; ++x) {
			var real   = (x-N2)*4.0/N;
			var imag   = (y-N2)*4.0/N;
			var real2  = real*real-imag*imag;
			var imag2  = 2*real*imag;
			var x2     = Math.round((real2*N/4+N2)*16);
			var y2     = Math.round((imag2*N/4+N2)*16);
			var index  = y*N + x;
			map[index*2  ] = (x2 - N2*16);
			map[index*2+1] = (y2 - N2*16);
			//map[index*2  ] = xi+yi*N;
		}
	}
	var buff1 = new Uint32Array( N*N + 1);
	var buff2 = new Uint32Array( N*N + 1);

	offseti  = 0;
	offsetx  = 0;
	offsety  = 0;
	costheta = 0;
	sintheta = 0;
		
	noise_level = 200;
	blur_amount = 120;

	var buf  = new ArrayBuffer(imageData.data.length);
	var buf8 = new Uint8ClampedArray(buf);
	var data = new Uint32Array(buf);
	
	canvas.onmousemove = function(e) {
		var mouseX, mouseY;
    	mouseX = e.clientX-canvas.offsetLeft-N2;
	    mouseY = e.clientY-canvas.offsetTop-N2;
		offsetx = mouseX*16 + N2*16;
		offsety = mouseY*16 + N2*16;
	
		mouseTheta  = Math.atan2(mouseX,mouseY);
		mouseRadius = 300;
		costheta    = Math.cos(mouseTheta)*mouseRadius;
		sintheta    = Math.sin(mouseTheta)*mouseRadius;
	};
	
	function render() {
		var rand = Math.floor(Math.random()*0x1000000);
		
		var writeindex = 0;
		var mapindex = 0;
		for (var y = 0; y < N; ++y)
		for (var x = 0; x < N; ++x) {
			var x3 = map[mapindex  ]+offsetx;
			var y3 = map[mapindex+1]+offsety;
			var xi = x3>>4;
			var yi = y3>>4;
			if (xi>=0 && yi>=0 && xi<N && yi<N) {
				var xf = x3&0xf;
				var yf = y3&0xf;
				var xg = 16-xf;
				var yg = 16-yf;
				var index = xi+yi*N;
				var colorA = buff1[index    &0x3ffff];
				var colorB = buff1[index  +1&0x3ffff];
				var colorC = buff1[index+N  &0x3ffff];
				var colorD = buff1[index+N+1&0x3ffff];
				var colorE = (colorA*xg+colorB*xf>>4) & 0xf0f0f0;
				var colorF = (colorC*xg+colorD*xf>>4) & 0xf0f0f0;
				var color  = (colorE*yg+colorF*yf>>4) & 0xf0f0f0;
				//color = (0xf8f8f8&color)*7>>3;
				if (color>0x080808) color -= 0x080808; 
			} else color=rand;
			color &= 0xf0f0f0;
			data[writeindex]  = 0xff000000|color;
			buff2[writeindex] = color;
			mapindex += 2;
			writeindex ++;
		}
		
		imageData.data.set(buf8);
		ctx.putImageData(imageData, 0, 0);
		
		var temp = buff2;
		buff2 = buff1;
		buff1 = temp;
		
		setTimeout(render, 0);
	}
	
	render();
}

</script>
</body>
</html>


